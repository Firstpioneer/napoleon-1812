开发指导书 V4.1：节点交互与深层叙事接入
1. 核心交互流设计 (Interaction Flow)
我们将原有的 SideDrawer (右侧详情板) 改造为双模式容器：
模式 A：统计概览 (Statistics Mode) - 当前已实现
触发：时间刷选 / 图例筛选。
内容：显示兵力损耗统计、死因分析。
模式 B：情报简报 (Briefing Mode) - 新增
触发：点击地图上的关键事件节点。
内容：战役标题、核心图片、简短摘要。
出口：点击卡片底部的 [Access Full Archive / 查看详细档案] 按钮，路由跳转至详情页。
2. 数据层增补 (Data Layer)
我们需要整理一份新的 data_battles.json，并将之前开发的页面逻辑映射到这里的 link_id。
code
TypeScript
// 类型定义
interface HistoricalEvent {
  id: string;          // 唯一标识
  title: string;       // e.g., "Battle of Borodino"
  date: string;        // 用于和时间轴联动
  coords: [number, number]; // [lon, lat]
  type: "Battle" | "City" | "Incident"; 
  summary: string;     // 侧边栏展示的简短描述
  thumbnail: string;   // 侧边栏展示的小图
  link_route: string;  // [关键] 点击后跳转的路由地址 (对应之前做的详情页)
}

// 示例数据
const events: HistoricalEvent[] = [
  {
    id: "evt_03",
    title: "博罗季诺战役 (Battle of Borodino)",
    date: "1812-09-07",
    coords: [35.816, 55.503],
    type: "Battle",
    summary: "这是1812年战役中血腥的一天，拿破仑虽胜但未能歼灭俄军主力...",
    thumbnail: "/assets/borodino_thumb.jpg",
    link_route: "/archives/borodino" // 这里对应你以前做的页面路由
  },
  // ... 其他战役
];
3. 地图组件升级：绘制交互节点 (Map Implementation)
在现有的 D3 路径层之上，增加一层 Node Layer。
关键代码逻辑 (React + D3)
code
TypeScript
// 在 TacticalMap 组件内部
// 1. 绘制路径的代码保持不变...

// 2. 新增：绘制关键节点
useEffect(() => {
  if (!map || !d3Group) return;

  const nodeGroup = d3Group.append("g").attr("class", "node-layer");

  // 数据绑定
  const nodes = nodeGroup.selectAll(".event-node")
    .data(events)
    .enter()
    .append("g")
    .attr("class", "event-node")
    // 添加点击交互
    .on("click", (e, d) => {
       e.stopPropagation(); // 防止触发地图底图点击
       props.onEventSelect(d); // 【关键】向上传递事件，通知父组件切换侧边栏
    })
    // 增加 Hover 效果提示可点击
    .on("mouseenter", function(e, d) {
       d3.select(this).selectAll("circle").attr("stroke", "#00d2ff"); // 高亮色
       // 这里也可以反向高亮时间轴上对应的点
    })
    .on("mouseleave", function(e, d) {
       d3.select(this).selectAll("circle").attr("stroke", "white");
    });

  // 节点外观：一个发光的外圈 + 一个实心内圈
  nodes.append("circle")
    .attr("r", 8) // 外圈
    .attr("fill", "rgba(0,0,0,0.5)")
    .attr("stroke", "white")
    .attr("stroke-width", 2)
    .classed("pulsing-marker", true); // 加 CSS 动画类

  nodes.append("circle") 
    .attr("r", 4) // 内核
    .attr("fill", (d) => d.type === 'Battle' ? '#ff3333' : '#ffae00');

  // 位置更新逻辑 (必须绑定到 Leaflet/Mapbox 的移动事件)
  function updatePositions() {
    nodes.attr("transform", d => {
      // 这里的 project 是将经纬度转为屏幕像素的方法 (Leaflet/Mapbox 提供的)
      const point = project(d.coords); 
      return `translate(${point.x}, ${point.y})`;
    });
  }

  // 绑定更新
  map.on("moveend", updatePositions);
  updatePositions(); // 初始计算

}, [map]);
CSS 动画增强 (Pulsing Effect)
为节点添加呼吸灯效果，暗示用户“我是可点击的”。
code
CSS
.pulsing-marker {
  animation: pulse 2s infinite;
  transform-origin: center;
}

@keyframes pulse {
  0% { r: 8px; opacity: 1; stroke-opacity: 1; }
  50% { r: 12px; opacity: 0; stroke-opacity: 0; }
  100% { r: 8px; opacity: 0; stroke-opacity: 0; }
}

.event-node {
  cursor: pointer; /* 鼠标变手型 */
  pointer-events: auto; /* 确保能点到 */
}
4. 侧边栏升级：路由接入 (Side Panel & Router)
这部分负责处理“点击后”的逻辑。
修改主页面状态 (App.tsx)
code
TypeScript
const App = () => {
  // 定义状态：当前展示的模式 'STATS' | 'BRIEFING'
  const [drawerMode, setDrawerMode] = useState<'STATS' | 'BRIEFING'>('STATS');
  const [selectedEvent, setSelectedEvent] = useState<HistoricalEvent | null>(null);

  // 处理节点点击
  const handleEventClick = (evt: HistoricalEvent) => {
    setSelectedEvent(evt);
    setDrawerMode('BRIEFING'); // 切换模式
    // 可选：让侧边栏如果收起了，自动弹出来
    setIsDrawerOpen(true);
  };
  
  // 处理刷选恢复
  const handleBrushStart = () => {
    setDrawerMode('STATS'); // 用户开始看宏观数据了，切回统计模式
  };

  return (
    <>
      <TacticalMap onEventSelect={handleEventClick} ... />
      {/* 传参给侧边栏 */}
      <SideDrawer mode={drawerMode} eventData={selectedEvent} ... />
      ...
    </>
  )
}
侧边栏组件逻辑 (SideDrawer.tsx)
这是将你的新老作业缝合的关键点。
code
Tsx
import { useNavigate } from 'react-router-dom';

const SideDrawer = ({ mode, eventData, statsData }) => {
  const navigate = useNavigate();

  return (
    <div className="drawer-content">
      {mode === 'STATS' ? (
         // 原来的代码：显示死因、柱状图等
         <StatisticsPanel data={statsData} />
      ) : (
         // 新增：情报简报模式
         <div className="briefing-card animate-slide-in">
            <div className="card-header">
               <h3>TACTICAL BRIEFING</h3> {/* 保持军事风格 */}
               <div className="date-badge">{eventData.date}</div>
            </div>
            
            <img src={eventData.thumbnail} className="briefing-img" />
            
            <h2>{eventData.title}</h2>
            <p>{eventData.summary}</p>

            {/* 跳转按钮 */}
            <button 
              className="action-btn"
              onClick={() => navigate(eventData.link_route)}
            >
              ACCESS FULL ARCHIVES 
              <span className="icon">→</span>
            </button>
            
            {/* 视觉提示 */}
            <div className="status-line">INTELLIGENCE LEVEL: DETAILED</div>
         </div>
      )}
    </div>
  );
};
5. 路由结构配置 (Router Setup)
如果你还没有配路由，需要在 index.tsx 或 main.tsx 中包一层。
code
Tsx
import { BrowserRouter, Routes, Route } from "react-router-dom";
import Dashboard from "./Dashboard"; // 你的 V4.0 主大屏
import BattleDetail from "./details/BattleDetail"; // 你之前的详细页面组件

const Root = () => (
  <BrowserRouter>
    <Routes>
      {/* 默认首页：战术指挥台 */}
      <Route path="/" element={<Dashboard />} />
      
      {/* 详情页路由：匹配 link_route */}
      {/* 这里的 Component 可是你之前做的页面组件，套一个公共Layout即可 */}
      <Route path="/archives/borodino" element={<BattleDetail battleId="borodino" />} />
      <Route path="/archives/moscow" element={<BattleDetail battleId="moscow" />} />
      {/* ... */}
    </Routes>
  </BrowserRouter>
);
6. 用户体验微调建议
返回逻辑：在你的详情页（BattleDetail）左上角，务必加一个 [← Back to Command Center] 按钮，链接回 /，保证浏览体验不中断。
动画衔接：
SideDrawer: 从右侧 translateX 滑出。
Route Transition: 如果有能力，使用 framer-motion 做页面切换，详情页最好以“文档打开”的动画浮在上面，而不是硬生生跳转，这样更像是一个App。
色彩区分：简报模式（BRIEFING）的侧边栏背景色可以稍微变深或带有一点红色警示边框（如果是战役节点），与默认的蓝色系统计面板做出区分，提示用户现在处于“聚焦局部”状态。
通过这一步 V4.1 的增补，你的系统逻辑形成了闭环：
[宏观刷选联动] <==> [点击下钻聚焦] <==> [沉浸式阅读]